services:
  mysql:
    image: mysql:8.0
    container_name: revcart-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-db:/docker-entrypoint-initdb.d
    networks:
      - revcart-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    restart: always

  redis:
    image: redis:7-alpine
    container_name: revcart-redis
    ports:
      - "6379:6379"
    networks:
      - revcart-network
    restart: always

  user-service:
    image: ${DOCKER_REGISTRY}/revcart-user-service:latest
    container_name: user-service
    ports:
      - "8081:8081"
    environment:
      - SERVER_PORT=8081
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_MAIL_HOST=smtp.gmail.com
      - SPRING_MAIL_PORT=587
      - SPRING_MAIL_USERNAME=admin@gmail.com
      - SPRING_MAIL_PASSWORD=admin@1234
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH=true
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE=true
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION}
      - SPRING_SECURITY_CSRF_ENABLED=false
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  product-service:
    image: ${DOCKER_REGISTRY}/revcart-product-service:latest
    container_name: product-service
    ports:
      - "8082:8082"
    environment:
      - SERVER_PORT=8082
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  cart-service:
    image: ${DOCKER_REGISTRY}/revcart-cart-service:latest
    container_name: cart-service
    ports:
      - "8083:8083"
    environment:
      - SERVER_PORT=8083
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  order-service:
    image: ${DOCKER_REGISTRY}/revcart-order-service:latest
    container_name: order-service
    ports:
      - "8084:8084"
    environment:
      - SERVER_PORT=8084
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  payment-service:
    image: ${DOCKER_REGISTRY}/revcart-payment-service:latest
    container_name: payment-service
    ports:
      - "8085:8085"
    environment:
      - SERVER_PORT=8085
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  delivery-service:
    image: ${DOCKER_REGISTRY}/revcart-delivery-service:latest
    container_name: delivery-service
    ports:
      - "8086:8086"
    environment:
      - SERVER_PORT=8086
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  notification-service:
    image: ${DOCKER_REGISTRY}/revcart-notification-service:latest
    container_name: notification-service
    ports:
      - "8087:8087"
    environment:
      - SERVER_PORT=8087
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  analytics-service:
    image: ${DOCKER_REGISTRY}/revcart-analytics-service:latest
    container_name: analytics-service
    ports:
      - "8088:8088"
    environment:
      - SERVER_PORT=8088
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE}
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SERVICES_ORDER-SERVICE_URL=http://order-service:8084
      - SERVICES_PRODUCT-SERVICE_URL=http://product-service:8082
      - SERVICES_USER-SERVICE_URL=http://user-service:8081
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - revcart-network
    restart: always

  revcart-gateway:
    image: ${DOCKER_REGISTRY}/revcart-gateway:latest
    container_name: revcart-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_CLOUD_GATEWAY_ROUTES[0]_ID=user-service
      - SPRING_CLOUD_GATEWAY_ROUTES[0]_URI=http://user-service:8081
      - SPRING_CLOUD_GATEWAY_ROUTES[0]_PREDICATES[0]=Path=/api/users/**
      - SPRING_CLOUD_GATEWAY_ROUTES[1]_ID=product-service
      - SPRING_CLOUD_GATEWAY_ROUTES[1]_URI=http://product-service:8082
      - SPRING_CLOUD_GATEWAY_ROUTES[1]_PREDICATES[0]=Path=/api/products/**
      - SPRING_CLOUD_GATEWAY_ROUTES[2]_ID=category-service
      - SPRING_CLOUD_GATEWAY_ROUTES[2]_URI=http://product-service:8082
      - SPRING_CLOUD_GATEWAY_ROUTES[2]_PREDICATES[0]=Path=/api/categories/**
      - SPRING_CLOUD_GATEWAY_GLOBALCORS_CORSCONFIGURATIONS_[/**]_ALLOWEDORIGINS=*
      - SPRING_CLOUD_GATEWAY_GLOBALCORS_CORSCONFIGURATIONS_[/**]_ALLOWEDMETHODS=*
      - SPRING_CLOUD_GATEWAY_GLOBALCORS_CORSCONFIGURATIONS_[/**]_ALLOWEDHEADERS=*
      - SPRING_CLOUD_GATEWAY_GLOBALCORS_CORSCONFIGURATIONS_[/**]_ALLOWCREDENTIALS=true
    depends_on:
      - user-service
      - product-service
    networks:
      - revcart-network
    restart: always

  frontend:
    image: ${DOCKER_REGISTRY}/revcart-frontend:latest
    container_name: revcart-frontend
    ports:
      - "80:80"
    depends_on:
      - revcart-gateway
    networks:
      - revcart-network
    restart: always

volumes:
  mysql_data:

networks:
  revcart-network:
    driver: bridge